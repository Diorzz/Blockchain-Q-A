# 闪电网络概念与技术原理

## 引言

闪电网络最早是针对比特币链上处理交易速度慢而提出的链下支付技术，闪电网络的理念是将小额多频的交易放到链下完成，在链上仅记录最终的成交状态，这样就能提高比特币交易的处理速度。

## 预备知识

要了解闪电网络基本原理，你需要知道以下内容：
- 比特币交易的输入和输出
- 多重签名

### 比特币交易的输入和输出
比特币的交易是使用`UTXO`模型，即交易包含输入和输出，下一笔交易必须包含上一笔交易的输出才能被花出去。形象地比喻：如果Alice给Bob转一笔钱，那么就相当于Alice把钱放在了一个Bob才能打开的箱子里面，当Bob想要花掉这笔钱给Jack时，Bob打开箱子然后把钱封装在只有Jack才能打开的箱子里，以此类推。

### 多重签名
多重签名，顾名思义即多个签名，如果我们把Bob的签名比作打开箱子的钥匙的话，那么多重签名就相当于一把复杂的锁，这个锁可能需要Alice和Bob的两把钥匙才能打开。

## 微支付通道
我们以Alice和Bob之间的交易来解释微支付通道的原理。首先，我们介绍两种交易：
- FTX
- RTX

其中FTX指的是支付交易，即Alice向一个多重签名地址（需要Alice和Bob的签名的地址）发送N个比特币，例如1BTC。RTX是指Alice构造一个指向自己的交易，交易的输入是FTX的输出，并且该交易有锁定期（多少天之后触发）详细情况如下图所示：

![image](images/lighting-1.png)

在这基础上，Alice就可以和Bob一些不超过1BTC的支付了：假设Alice在Bob的商铺买了一个iphone花掉0.5BTC，为了给BTC转这笔钱，ALice这样做：

- 首先ALice把之前构造好的RTX发送给Bob，Bob进行签名并发送给Alice
- Alice拿到Bob签名好的RTX，广播FTX
- Alice构造另一笔交易FTX2，两个输出，分别为Alice 0.5BTC和Bob 0.5BTC
- ALice将FTX2签名并发给Bob
- Bob如果接受，就签名这笔交易

注意到上面的步骤，只广播了一次交易FTX，这就代表，只有这条交易被上链。而购买iphone的交易，Bob并没有广播。现在我们看看Alice和Bob手里有哪些可以拿到钱的证据：

Alice有一个Bob签了名的RTX，输入为FTX，输出为Alice这意味着Alice可以拿到FTX中所有的钱。Bob手里有一个Alice支付给他的0.5BTC的FTX2，这意味着Bob可以从FTX中拿到0.5BTC。所以对Bob来讲，必须在Alice广播RTX前把FTX2广播出去，这样才能不受到损失：

![image](images/lighting-2.png)

上面的图中已经很清楚地解释了当前的现状，注意：引用FTX的交易都需要双方的多重签名。在RTX没有执行之前，Alice和Bob可以创建无数个这样的微交易，对于Bob来说，只要在最后时刻前把最后的FTXN广播出去，就不会受到任何损失。